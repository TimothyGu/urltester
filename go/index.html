<!doctype html>
<meta charset=utf-8>
<title>Go net/url parser tester</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel=stylesheet integrity=sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0 crossorigin=anonymous>

<script src=wasm_exec.js></script>
<script>
  // Some HTTP servers don't yet set the Content-Type correctly for .wasm,
  // so use WebAssembly.compile rather than WebAssembly.compileStreaming.
  async function compile(resp) {
    const source = await (await resp).arrayBuffer();
    return WebAssembly.compile(source);
  };

  const modProm = compile(fetch("main.wasm"));
</script>

<main class=container>
  <h1>Go net/url tester</h1>
  <p>
    This page parses a given URL with the Go <a href="https://golang.org/pkg/net/url/">net/url</a>
    package. It does so by loading a WebAssembly module compiled from
    native Go code.
  </p>
  <label>URL to parse: <input type=text id=input value="https://timothygu.me/"></label>
  <pre id=output></pre>
</main>

<script>
  function enosys() {
    const err = new Error("not implemented");
    err.code = "ENOSYS";
    return err;
  }

  let running = false;
  async function run(url) {
    if (running) {
      return "waiting";
    }
    running = true;

    try {
      // Copied from wasm_exec.js.
      global.fullOutput = "";
      let outputBuf = "";
      const decoder = new TextDecoder("utf-8");
      global.fs.writeSync = (fd, buf) => {
        const decoded = decoder.decode(buf);
        global.fullOutput += decoded;
        outputBuf += decoded;
        const nl = outputBuf.lastIndexOf("\n");
        if (nl != -1) {
          console.log(outputBuf.substr(0, nl));
          outputBuf = outputBuf.substr(nl + 1);
        }
        return buf.length;
      };
      global.fs.write = (fd, buf, offset, length, position, callback) => {
        if (offset !== 0 || length !== buf.length || position !== null) {
          callback(enosys());
          return;
        }
        const n = global.fs.writeSync(fd, buf);
        callback(null, n);
      };

      const mod = await modProm;
      const go = new Go();
      global.go = go;
      const instance = await WebAssembly.instantiate(mod, go.importObject)
      go.argv = ["main", url];
      go.run(instance);
      return global.fullOutput;
    } finally {
      running = false;
    }
  }

  const inputEl = document.getElementById("input");
  const outputEl = document.getElementById("output");

  let prevRun = null;
  async function runAndUpdate() {
    console.log("input:", inputEl.value);
    await prevRun;
    prevRun = (async () => {
      try {
        const output = await run(inputEl.value);
        outputEl.innerText = output;
      } catch (ex) {
        outputEl.innerText = ex ? (ex.stack || ex.message || ex) : ex;
      }
    })();
  }

  runAndUpdate();
  inputEl.addEventListener("input", runAndUpdate);
</script>
