<!doctype html>
<html lang=en-US>
<meta charset=utf-8>
<title>Go net/url parser tester</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel=stylesheet integrity=sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0 crossorigin=anonymous>
<meta name="author" content="Timothy Gu <timothygu99@gmail.com>">

<script src=wasm_exec.js></script>
<script>
  // Some HTTP servers don't yet set the Content-Type correctly for .wasm,
  // so use WebAssembly.compile rather than WebAssembly.compileStreaming.
  async function compile(resp) {
    const source = await (await resp).arrayBuffer();
    return WebAssembly.compile(source);
  };

  const modProm = compile(fetch("main.wasm"));
</script>

<main class=container>
  <h1>Go net/url tester</h1>
  <p>
    This page parses a given URL with the Go <a href="https://golang.org/pkg/net/url/">net/url</a>
    package. It does so by loading a WebAssembly module compiled from
    native Go code.
  </p>
  <form>
    <label>URL to parse: <input type=text id=input value="https://timothygu.me/"></label>
    <label>Base URL: <input type=text id=base></label>
  </form>
  <pre id=output></pre>
</main>
<footer style="position: absolute; top: 1em; right: 1em; text-align: right;">
  <a href="https://github.com/TimothyGu/urltester/blob/main/LICENSE.md">MIT-licensed</a><br>
  <a href="https://github.com/TimothyGu/urltester">Fork me on GitHub!</a>
</footer>

<script>
  function enosys() {
    const err = new Error("not implemented");
    err.code = "ENOSYS";
    return err;
  }

  async function run(url, base) {
    // Copied from wasm_exec.js.
    global.fullOutput = "";
    let outputBuf = "";
    const decoder = new TextDecoder("utf-8");
    global.fs.writeSync = (fd, buf) => {
      const decoded = decoder.decode(buf);
      global.fullOutput += decoded;
      outputBuf += decoded;
      const nl = outputBuf.lastIndexOf("\n");
      if (nl != -1) {
        console.log(outputBuf.substr(0, nl));
        outputBuf = outputBuf.substr(nl + 1);
      }
      return buf.length;
    };
    global.fs.write = (fd, buf, offset, length, position, callback) => {
      if (offset !== 0 || length !== buf.length || position !== null) {
        callback(enosys());
        return;
      }
      const n = global.fs.writeSync(fd, buf);
      callback(null, n);
    };

    const mod = await modProm;
    const go = new Go();
    global.go = go;
    const instance = await WebAssembly.instantiate(mod, go.importObject)
    go.argv = ["main"];
    if (base) {
      go.argv.push(`-base=${base}`);
    }
    go.argv.push(`${url}`);
    go.run(instance);
    return global.fullOutput;
  }

  const inputEl = document.getElementById("input");
  const baseEl = document.getElementById("base");
  const outputEl = document.getElementById("output");

  let prevRun = null;
  async function runAndUpdate() {
    const input = inputEl.value;
    const base = baseEl.value;

    await prevRun;
    prevRun = (async () => {
      try {
        const output = await run(input, base);
        outputEl.innerText = output;
      } catch (ex) {
        outputEl.innerText = ex ? (ex.stack || ex.message || ex) : ex;
      }
    })();
  }

  runAndUpdate();
  inputEl.addEventListener("input", runAndUpdate);
  baseEl.addEventListener("input", runAndUpdate);
</script>
