<!doctype html>
<meta charset=utf-8>
<title>libcurl URL parser tester</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel=stylesheet integrity=sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0 crossorigin=anonymous>

<script>
  const wasmReady = new Promise(ready => {
    globalThis.outputToPrint = '';
    globalThis.Module = {
      print(...args) {
        console.log(...args);
        outputToPrint += args.join(' ') + '\n';
      },
      printErr(...args) {
        console.warn(...args);
        outputToPrint += args.join(' ') + '\n';
      },
      noInitialRun: true,
      onRuntimeInitialized() {
        ready();
      },
    };
  })

  async function runAndGetOutput(url, { encodeURL = false } = {}) {
    await wasmReady;
    globalThis.outputToPrint = '';
    const args = [];
    if (encodeURL) {
      args.push('-e');
    }
    args.push(url);
    callMain(args);
    return globalThis.outputToPrint;
  }
</script>
<script src="curltest.js"></script>

<main class=container>
  <h1>libcurl URL parser tester</h1>
  <p>
    This page parses a given URL with the libcurl URL API. It does so by
    loading a WebAssembly module compiled from native C code.
  </p>
  <label>URL to parse: <input type=text id=input value="https://timothygu.me/"></label>
  <pre id=output></pre>
</main>

<script>
  const inputEl = document.getElementById("input");
  const outputEl = document.getElementById("output");

  let prevRun = null;
  async function runAndUpdate() {
    console.log("input:", inputEl.value);
    await prevRun;
    prevRun = (async () => {
      try {
        const output = await runAndGetOutput(inputEl.value, { encodeURL: true });
        outputEl.innerText = output;
      } catch (ex) {
        outputEl.innerText = ex ? (ex.stack || ex.message || ex) : ex;
      }
    })();
  }

  runAndUpdate();
  inputEl.addEventListener("input", runAndUpdate);
</script>
