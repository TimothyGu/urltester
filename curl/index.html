<!doctype html>
<html lang=en-US>
<meta charset=utf-8>
<title>libcurl URL parser tester</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel=stylesheet integrity=sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0 crossorigin=anonymous>
<meta name="author" content="Timothy Gu <timothygu99@gmail.com>">

<script>
  const wasmReady = new Promise(ready => {
    globalThis.outputToPrint = "";
    globalThis.Module = {
      print(...args) {
        console.log(...args);
        outputToPrint += args.join(" ") + "\n";
      },
      printErr(...args) {
        console.warn(...args);
        outputToPrint += args.join(" ") + "\n";
      },
      noInitialRun: true,
      onRuntimeInitialized() {
        ready();
      },
    };
  })

  async function runAndGetOutput(url, { encodeURL = false, base = "" } = {}) {
    await wasmReady;
    globalThis.outputToPrint = "";
    const args = [];
    if (encodeURL) {
      args.push("-e");
    }
    if (base) {
      args.push("-b", base);
    }
    args.push(url);
    const saved = stackSave();
    console.log("saved as", saved);
    try {
      callMain(args);
    } finally {
      stackRestore(saved);
    }
    return globalThis.outputToPrint;
  }
</script>
<script src="curltest.js"></script>

<main class=container>
  <h1>libcurl URL parser tester</h1>
  <p>
    This page parses a given URL with the libcurl
    <a href="https://everything.curl.dev/libcurl/url">URL API</a>. It does so
    by loading a WebAssembly module compiled from native C code.
  </p>
  <form>
    <label>URL to parse: <input type=text id=input value="https://timothygu.me/"></label>
    <label>Base URL: <input type=text id=base></label>
    <label>Encode when parsing: <input type=checkbox id=encode checked></label>
  </form>
  <pre id=output></pre>
</main>
<footer style="position: absolute; top: 1em; right: 1em; text-align: right;">
  <a href="https://github.com/TimothyGu/urltester/blob/main/LICENSE.md">MIT-licensed</a><br>
  <a href="https://github.com/TimothyGu/urltester">Fork me on GitHub!</a>
</footer>

<script>
  const inputEl = document.getElementById("input");
  const baseEl = document.getElementById("base");
  const encodeEl = document.getElementById("encode");
  const outputEl = document.getElementById("output");

  let prevRun = null;
  async function runAndUpdate() {
    const input = inputEl.value;
    const base = baseEl.value;
    const encodeURL = encodeEl.value;

    await prevRun;
    prevRun = (async () => {
      try {
        const output = await runAndGetOutput(input, { encodeURL, base });
        outputEl.innerText = output;
      } catch (ex) {
        outputEl.innerText = ex ? (ex.stack || ex.message || ex) : ex;
      }
    })();
  }

  runAndUpdate();
  inputEl.addEventListener("input", runAndUpdate);
  baseEl.addEventListener("input", runAndUpdate);
  encodeEl.addEventListener("input", runAndUpdate);
</script>
